{% extends "base.html" %}

{% block title %}Home - AI Study Helper{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold text-primary mb-3">
                <i class="fas fa-brain me-3"></i>Welcome to AI Study Helper
            </h1>
            <p class="lead text-muted">Your intelligent companion for effective learning and study management</p>
        </div>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-md-6 col-lg-3">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <i class="fas fa-camera fa-3x text-primary"></i>
                </div>
                <h5 class="card-title">Enhanced OCR</h5>
                <p class="card-text">Extract text from handwritten notes, textbook pages, and diagrams using AI-powered OCR.</p>
                <button class="btn btn-primary" onclick="showOCRModal()">
                    <i class="fas fa-arrow-right me-2"></i>Start OCR
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <i class="fas fa-book fa-3x text-success"></i>
                </div>
                <h5 class="card-title">Manage Subjects</h5>
                <p class="card-text">Organize your study materials by subject and track your progress.</p>
                <a href="{{ url_for('subjects') }}" class="btn btn-success">
                    <i class="fas fa-arrow-right me-2"></i>Go to Subjects
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <i class="fas fa-clock fa-3x text-info"></i>
                </div>
                <h5 class="card-title">Track Study Time</h5>
                <p class="card-text">Monitor your study sessions and build consistent study habits.</p>
                <a href="{{ url_for('study_session') }}" class="btn btn-info">
                    <i class="fas fa-arrow-right me-2"></i>Start Session
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <i class="fas fa-sticky-note fa-3x text-warning"></i>
                </div>
                <h5 class="card-title">Create Flashcards</h5>
                <p class="card-text">Build a personalized flashcard deck for active recall practice.</p>
                <a href="{{ url_for('flashcards') }}" class="btn btn-warning">
                    <i class="fas fa-arrow-right me-2"></i>View Cards
                </a>
            </div>
        </div>
    </div>
</div>

<!-- OCR Modal -->
<div class="modal" id="ocrModal" style="display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-xl" style="margin: 1.75rem auto; max-width: 90%;">
        <div class="modal-content" style="background-color: white; border-radius: 0.375rem; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);">
            <div class="modal-header bg-primary text-white" style="padding: 1rem; border-bottom: 1px solid #dee2e6; border-top-left-radius: 0.375rem; border-top-right-radius: 0.375rem;">
                <h5 class="modal-title" id="ocrModalLabel">
                    <i class="fas fa-camera me-2"></i>Enhanced OCR Image Processing
                </h5>
                <button type="button" class="btn-close btn-close-white" onclick="closeOCRModal()" aria-label="Close" style="background: none; border: none; font-size: 1.5rem; color: white; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1rem;">
                <!-- OCR System Info -->
                <div class="alert alert-info mb-3" style="background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 0.75rem; border-radius: 0.375rem;">
                    <h6><i class="fas fa-info-circle me-2"></i>Enhanced OCR Capabilities</h6>
                    <p class="mb-1"><strong>Supported:</strong> Handwritten notes, textbook pages, diagrams, mathematical content, low-quality images</p>
                    <p class="mb-0"><strong>Features:</strong> Advanced preprocessing, content classification, study suggestions, text filtering</p>
                </div>

                <!-- Single File Upload -->
                <div class="mb-4">
                    <h6><i class="fas fa-image me-2"></i>Single Image Upload</h6>
                    <div class="upload-area border-2 border-dashed border-primary rounded p-4 text-center" id="singleUploadArea">
                        <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-3"></i>
                        <h6>Drag & Drop Image Here</h6>
                        <p class="text-muted small">or click to browse</p>
                        <p class="text-muted small">Supports: PNG, JPG, GIF, BMP, TIFF, WEBP</p>
                        <input type="file" id="singleFileInput" accept="image/*" class="d-none">
                        <button class="btn btn-primary btn-sm" onclick="document.getElementById('singleFileInput').click()">
                            <i class="fas fa-folder-open me-2"></i>Choose Image
                        </button>
                    </div>
                </div>

                <!-- Batch File Upload -->
                <div class="mb-4">
                    <h6><i class="fas fa-images me-2"></i>Batch Image Upload</h6>
                    <div class="upload-area border-2 border-dashed border-success rounded p-4 text-center" id="batchUploadArea">
                        <i class="fas fa-cloud-upload-alt fa-2x text-success mb-3"></i>
                        <h6>Drag & Drop Multiple Images Here</h6>
                        <p class="text-muted small">or click to browse multiple files</p>
                        <p class="text-muted small">Supports: PNG, JPG, GIF, BMP, TIFF, WEBP</p>
                        <input type="file" id="batchFileInput" accept="image/*" multiple class="d-none">
                        <button class="btn btn-success btn-sm" onclick="document.getElementById('batchFileInput').click()">
                            <i class="fas fa-folder-open me-2"></i>Choose Multiple Images
                        </button>
                    </div>
                </div>

                <!-- Processing Status -->
                <div class="processing-spinner text-center d-none" id="processingSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <p class="mt-2 text-muted">Processing image with enhanced OCR...</p>
                    <small class="text-muted">This may take a few moments for complex images</small>
                </div>

                <!-- Results -->
                <div id="ocrResults" class="d-none">
                    <h6><i class="fas fa-file-alt me-2"></i>OCR Results & Analysis</h6>
                    
                    <!-- Content Classification -->
                    <div class="row mb-3" id="contentClassification">
                        <!-- Will be populated dynamically -->
                    </div>
                    
                    <!-- Text Results -->
                    <div class="card bg-light mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Extracted Text</h6>
                        </div>
                        <div class="card-body">
                            <div id="resultsContent"></div>
                        </div>
                    </div>
                    
                    <!-- Study Suggestions -->
                    <div class="card bg-success text-white mb-3" id="studySuggestions">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>AI Study Suggestions</h6>
                        </div>
                        <div class="card-body">
                            <div id="suggestionsContent"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 0.75rem; border-top: 1px solid #dee2e6; text-align: right;">
                <button type="button" class="btn btn-secondary" onclick="closeOCRModal()" style="background-color: #6c757d; border-color: #6c757d; color: white; padding: 0.375rem 0.75rem; border-radius: 0.375rem; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Study Tips
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-check-circle text-success me-2"></i>Pomodoro Technique</h6>
                        <p class="text-muted">Study in 25-minute focused sessions with 5-minute breaks.</p>
                        
                        <h6><i class="fas fa-check-circle text-success me-2"></i>Active Recall</h6>
                        <p class="text-muted">Test yourself instead of just re-reading material.</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-check-circle text-success me-2"></i>Spaced Repetition</h6>
                        <p class="text-muted">Review material at increasing intervals for better retention.</p>
                        
                        <h6><i class="fas fa-check-circle text-success me-2"></i>Interleaving</h6>
                        <p class="text-muted">Mix different subjects or topics in a single study session.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-quick-actions me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('add_subject') }}" class="btn btn-outline-primary">
                        <i class="fas fa-plus me-2"></i>Add New Subject
                    </a>
                    <a href="{{ url_for('add_flashcard') }}" class="btn btn-outline-warning">
                        <i class="fas fa-plus me-2"></i>Create Flashcard
                    </a>
                    <a href="{{ url_for('study_session') }}" class="btn btn-outline-success">
                        <i class="fas fa-play me-2"></i>Start Studying
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<style>
.upload-area {
    border: 2px dashed #6c5ce7;
    border-radius: 10px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    background-color: #f8f9fa;
    cursor: pointer;
}
.upload-area:hover {
    border-color: #5f4dd0;
    background-color: #e9ecef;
}
.upload-area.dragover {
    border-color: #5f4dd0;
    background-color: #e9ecef;
    transform: scale(1.02);
}

#batchUploadArea {
    border-color: #28a745;
}
#batchUploadArea:hover {
    border-color: #218838;
    background-color: #e9ecef;
}
#batchUploadArea.dragover {
    border-color: #218838;
    background-color: #e9ecef;
}
.confidence-high { color: #28a745; }
.confidence-medium { color: #ffc107; }
.confidence-low { color: #dc3545; }
.content-badge {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-weight: 500;
}
</style>

<script>
// Global variables
let currentFile = null;
let currentFiles = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    setupDragAndDrop();
    setupFileInputs();
    
    // Add click outside modal to close
    const modal = document.getElementById('ocrModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeOCRModal();
            }
        });
    }
});

// Setup drag and drop functionality
function setupDragAndDrop() {
    const singleArea = document.getElementById('singleUploadArea');
    const batchArea = document.getElementById('batchUploadArea');
    setupDragAndDropArea(singleArea, false);
    setupDragAndDropArea(batchArea, true);
}

function setupDragAndDropArea(area, isBatch) {
    area.addEventListener('dragover', function(e) {
        e.preventDefault();
        area.classList.add('dragover');
    });
    
    area.addEventListener('dragleave', function(e) {
        e.preventDefault();
        area.classList.remove('dragover');
    });
    
    area.addEventListener('drop', function(e) {
        e.preventDefault();
        area.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            if (isBatch) {
                currentFiles = Array.from(files);
                processBatchFiles();
            } else {
                currentFile = files[0];
                processSingleFile();
            }
        }
    });
    
    area.addEventListener('click', function() {
        if (isBatch) {
            document.getElementById('batchFileInput').click();
        } else {
            document.getElementById('singleFileInput').click();
        }
    });
}

function processBatchFiles() {
    if (!currentFiles || currentFiles.length === 0) return;
    
    showProcessingSpinner();
    
    const formData = new FormData();
    currentFiles.forEach((file, index) => {
        formData.append('files', file);
    });
    
    fetch('/api/ocr/batch', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideProcessingSpinner();
        if (data.success) {
            showBatchResults(data);
        } else {
            showError(data.error || 'Batch processing failed');
        }
    })
    .catch(error => {
        hideProcessingSpinner();
        showError('Network error: ' + error.message);
    });
}

function showBatchResults(data) {
    const resultsDiv = document.getElementById('ocrResults');
    const contentDiv = document.getElementById('resultsContent');
    const classificationDiv = document.getElementById('contentClassification');
    const suggestionsDiv = document.getElementById('suggestionsContent');
    
    // Show batch summary
    classificationDiv.innerHTML = `
        <div class="col-12">
            <div class="alert alert-success">
                <strong>Batch Processing Complete!</strong> 
                <span class="content-badge bg-success text-white">${data.results ? data.results.length : 0} files processed</span>
            </div>
        </div>
    `;
    
    // Show batch results
    let resultsHtml = '<h6>Batch Results:</h6>';
    if (data.results && data.results.length > 0) {
        data.results.forEach((result, index) => {
            const confidenceClass = result.confidence > 0.8 ? 'confidence-high' : 
                                   result.confidence > 0.6 ? 'confidence-medium' : 'confidence-low';
            
            resultsHtml += `
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>File ${index + 1}:</strong> ${result.filename || 'Unknown'}
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Confidence:</strong> <span class="${confidenceClass}">${(result.confidence * 100).toFixed(1)}%</span></p>
                                <p><strong>Word Count:</strong> ${result.word_count || 0}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Content Type:</strong> ${result.content_type ? result.content_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown'}</p>
                                <p><strong>Processing Time:</strong> ${result.processing_time ? result.processing_time.toFixed(2) + 's' : 'N/A'}</p>
                            </div>
                        </div>
                        <hr>
                        <h6>Extracted Text:</h6>
                        <div class="bg-white p-3 rounded border">
                            <pre class="mb-0" style="white-space: pre-wrap;">${result.text || 'No text extracted'}</pre>
                        </div>
                    </div>
                </div>
            `;
        });
    } else {
        resultsHtml += '<p class="text-muted">No results available.</p>';
    }
    
    contentDiv.innerHTML = resultsHtml;
    
    // Hide study suggestions for batch processing
    suggestionsDiv.classList.add('d-none');
    
    resultsDiv.classList.remove('d-none');
}

function setupFileInputs() {
    const singleInput = document.getElementById('singleFileInput');
    const batchInput = document.getElementById('batchFileInput');
    
    singleInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            currentFile = e.target.files[0];
            processSingleFile();
        }
    });
    
    batchInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            currentFiles = Array.from(e.target.files);
            processBatchFiles();
        }
    });
}

function processSingleFile() {
    if (!currentFile) return;
    
    const formData = new FormData();
    formData.append('file', currentFile);
    
    showProcessingSpinner();
    
    fetch('/api/ocr/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideProcessingSpinner();
        if (data.success) {
            showResults(data);
        } else {
            showError(data.error || 'Processing failed');
        }
    })
    .catch(error => {
        hideProcessingSpinner();
        showError('Network error: ' + error.message);
    });
}

function showProcessingSpinner() {
    document.getElementById('processingSpinner').classList.remove('d-none');
    document.getElementById('ocrResults').classList.add('d-none');
}

function hideProcessingSpinner() {
    document.getElementById('processingSpinner').classList.add('d-none');
}

function showResults(data) {
    const resultsDiv = document.getElementById('ocrResults');
    const contentDiv = document.getElementById('resultsContent');
    const classificationDiv = document.getElementById('contentClassification');
    const suggestionsDiv = document.getElementById('suggestionsContent');
    
    // Show content classification
    if (data.content_type) {
        const contentType = data.content_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        classificationDiv.innerHTML = `
            <div class="col-12">
                <div class="alert alert-primary">
                    <strong>Content Type Detected:</strong> 
                    <span class="content-badge bg-primary text-white">${contentType}</span>
                </div>
            </div>
        `;
    }
    
    // Show text results
    const confidenceClass = data.confidence > 0.8 ? 'confidence-high' : 
                           data.confidence > 0.6 ? 'confidence-medium' : 'confidence-low';
    
    contentDiv.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>Filename:</strong> ${data.filename || 'Unknown'}</p>
                <p><strong>Confidence:</strong> <span class="${confidenceClass}">${(data.confidence * 100).toFixed(1)}%</span></p>
                <p><strong>Processing Time:</strong> ${data.processing_time ? data.processing_time.toFixed(2) + 's' : 'N/A'}</p>
                <p><strong>Word Count:</strong> ${data.word_count || 0}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Character Count:</strong> ${data.char_count || 0}</p>
                <p><strong>Preprocessed:</strong> ${data.preprocessed ? 'Yes' : 'No'}</p>
                <p><strong>Content Type:</strong> ${data.content_type ? data.content_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown'}</p>
            </div>
        </div>
        <hr>
        <h6>Extracted Text:</h6>
        <div class="bg-white p-3 rounded border">
            <pre class="mb-0" style="white-space: pre-wrap;">${data.text || 'No text extracted'}</pre>
        </div>
    `;
    
    // Show study suggestions
    if (data.suggestions) {
        suggestionsDiv.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <h6><i class="fas fa-clipboard-list me-2"></i>Summary</h6>
                    <p class="mb-2">${data.suggestions.summary || 'No summary available'}</p>
                </div>
                <div class="col-md-4">
                    <h6><i class="fas fa-lightbulb me-2"></i>Explanation</h6>
                    <p class="mb-2">${data.suggestions.explanation || 'No explanation available'}</p>
                </div>
                <div class="col-md-4">
                    <h6><i class="fas fa-question-circle me-2"></i>Quiz Questions</h6>
                    <ul class="list-unstyled mb-0">
                        ${data.suggestions.quiz_questions ? data.suggestions.quiz_questions.map(q => `<li>â€¢ ${q}</li>`).join('') : '<li>No questions available</li>'}
                    </ul>
                </div>
            </div>
        `;
    } else {
        suggestionsDiv.innerHTML = `
            <div class="text-center">
                <p class="mb-0">No study suggestions available for this content type.</p>
            </div>
        `;
    }
    
    resultsDiv.classList.remove('d-none');
}

function showError(message) {
    const resultsDiv = document.getElementById('ocrResults');
    const contentDiv = document.getElementById('resultsContent');
    const classificationDiv = document.getElementById('contentClassification');
    const suggestionsDiv = document.getElementById('studySuggestions');
    
    classificationDiv.innerHTML = '';
    suggestionsDiv.classList.add('d-none');
    
    contentDiv.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error:</strong> ${message}
        </div>
    `;
    
    resultsDiv.classList.remove('d-none');
}

function showOCRModal() {
    try {
        const modalElement = document.getElementById('ocrModal');
        if (!modalElement) {
            console.error('OCR modal element not found!');
            return;
        }
        
        // Show the modal
        modalElement.style.display = 'block';
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
        
        console.log('OCR modal shown successfully');
    } catch (error) {
        console.error('Error showing OCR modal:', error);
    }
}

function closeOCRModal() {
    try {
        const modalElement = document.getElementById('ocrModal');
        if (!modalElement) return;
        
        // Hide the modal
        modalElement.style.display = 'none';
        document.body.style.overflow = 'auto'; // Restore background scrolling
        
        console.log('OCR modal closed successfully');
    } catch (error) {
        console.error('Error closing OCR modal:', error);
    }
}


</script>




{% extends "base.html" %}

{% block title %}Home - AI Study Helper{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold text-primary mb-3">
                <i class="fas fa-brain me-3"></i>Welcome to AI Study Helper
            </h1>
            <p class="lead text-muted">Your intelligent companion for effective learning and study management</p>
        </div>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-md-6 col-lg-3">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <i class="fas fa-camera fa-3x text-primary"></i>
                </div>
                <h5 class="card-title">Enhanced OCR</h5>
                <p class="card-text">Extract text from handwritten notes, textbook pages, and diagrams using AI-powered OCR.</p>
                <button class="btn btn-primary" onclick="showOCRModal()">
                    <i class="fas fa-arrow-right me-2"></i>Start OCR
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <i class="fas fa-book fa-3x text-success"></i>
                </div>
                <h5 class="card-title">Manage Subjects</h5>
                <p class="card-text">Organize your study materials by subject and track your progress.</p>
                <a href="{{ url_for('subjects') }}" class="btn btn-success">
                    <i class="fas fa-arrow-right me-2"></i>Go to Subjects
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <i class="fas fa-clock fa-3x text-info"></i>
                </div>
                <h5 class="card-title">Track Study Time</h5>
                <p class="card-text">Monitor your study sessions and build consistent study habits.</p>
                <a href="{{ url_for('study_session') }}" class="btn btn-info">
                    <i class="fas fa-arrow-right me-2"></i>Start Session
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <i class="fas fa-sticky-note fa-3x text-warning"></i>
                </div>
                <h5 class="card-title">Create Flashcards</h5>
                <p class="card-text">Build a personalized flashcard deck for active recall practice.</p>
                <a href="{{ url_for('flashcards') }}" class="btn btn-warning">
                    <i class="fas fa-arrow-right me-2"></i>View Cards
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Study Tips
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-check-circle text-success me-2"></i>Pomodoro Technique</h6>
                        <p class="text-muted">Study in 25-minute focused sessions with 5-minute breaks.</p>
                        
                        <h6><i class="fas fa-check-circle text-success me-2"></i>Active Recall</h6>
                        <p class="text-muted">Test yourself instead of just re-reading material.</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-check-circle text-success me-2"></i>Spaced Repetition</h6>
                        <p class="text-muted">Review material at increasing intervals for better retention.</p>
                        
                        <h6><i class="fas fa-check-circle text-success me-2"></i>Interleaving</h6>
                        <p class="text-muted">Mix different subjects or topics in a single study session.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-quick-actions me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('add_subject') }}" class="btn btn-outline-primary">
                        <i class="fas fa-plus me-2"></i>Add New Subject
                    </a>
                    <a href="{{ url_for('add_flashcard') }}" class="btn btn-outline-warning">
                        <i class="fas fa-plus me-2"></i>Create Flashcard
                    </a>
                    <a href="{{ url_for('study_session') }}" class="btn btn-outline-success">
                        <i class="fas fa-play me-2"></i>Start Studying
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<style>
.upload-area {
    border: 2px dashed #6c5ce7;
    border-radius: 10px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    background-color: #f8f9fa;
    cursor: pointer;
}
.upload-area:hover {
    border-color: #5f4dd0;
    background-color: #e9ecef;
}
.upload-area.dragover {
    border-color: #5f4dd0;
    background-color: #e9ecef;
    transform: scale(1.02);
}
.confidence-high { color: #28a745; }
.confidence-medium { color: #ffc107; }
.confidence-low { color: #dc3545; }
.content-badge {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-weight: 500;
}
</style>

<script>
// Global variables
let currentFile = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    setupDragAndDrop();
    setupFileInputs();
});

// Setup drag and drop functionality
function setupDragAndDrop() {
    const singleArea = document.getElementById('singleUploadArea');
    setupDragAndDropArea(singleArea, false);
}

function setupDragAndDropArea(area, isBatch) {
    area.addEventListener('dragover', function(e) {
        e.preventDefault();
        area.classList.add('dragover');
    });
    
    area.addEventListener('dragleave', function(e) {
        e.preventDefault();
        area.classList.remove('dragover');
    });
    
    area.addEventListener('drop', function(e) {
        e.preventDefault();
        area.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            if (isBatch) {
                currentFiles = Array.from(files);
                processBatchFiles();
            } else {
                currentFile = files[0];
                processSingleFile();
            }
        }
    });
    
    area.addEventListener('click', function() {
        if (isBatch) {
            document.getElementById('batchFileInput').click();
        } else {
            document.getElementById('singleFileInput').click();
        }
    });
}

function setupFileInputs() {
    const singleInput = document.getElementById('singleFileInput');
    singleInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            currentFile = e.target.files[0];
            processSingleFile();
        }
    });
}

function processSingleFile() {
    if (!currentFile) return;
    
    const formData = new FormData();
    formData.append('file', currentFile);
    
    showProcessingSpinner();
    
    fetch('/api/ocr/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideProcessingSpinner();
        if (data.success) {
            showResults(data);
        } else {
            showError(data.error || 'Processing failed');
        }
    })
    .catch(error => {
        hideProcessingSpinner();
        showError('Network error: ' + error.message);
    });
}

function showProcessingSpinner() {
    document.getElementById('processingSpinner').classList.remove('d-none');
    document.getElementById('ocrResults').classList.add('d-none');
}

function hideProcessingSpinner() {
    document.getElementById('processingSpinner').classList.add('d-none');
}

function showResults(data) {
    const resultsDiv = document.getElementById('ocrResults');
    const contentDiv = document.getElementById('resultsContent');
    const classificationDiv = document.getElementById('contentClassification');
    const suggestionsDiv = document.getElementById('suggestionsContent');
    
    // Show content classification
    if (data.content_type) {
        const contentType = data.content_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        classificationDiv.innerHTML = `
            <div class="col-12">
                <div class="alert alert-primary">
                    <strong>Content Type Detected:</strong> 
                    <span class="content-badge bg-primary text-white">${contentType}</span>
                </div>
            </div>
        `;
    }
    
    // Show text results
    const confidenceClass = data.confidence > 0.8 ? 'confidence-high' : 
                           data.confidence > 0.6 ? 'confidence-medium' : 'confidence-low';
    
    contentDiv.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>Filename:</strong> ${data.filename || 'Unknown'}</p>
                <p><strong>Confidence:</strong> <span class="${confidenceClass}">${(data.confidence * 100).toFixed(1)}%</span></p>
                <p><strong>Processing Time:</strong> ${data.processing_time ? data.processing_time.toFixed(2) + 's' : 'N/A'}</p>
                <p><strong>Word Count:</strong> ${data.word_count || 0}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Character Count:</strong> ${data.char_count || 0}</p>
                <p><strong>Preprocessed:</strong> ${data.preprocessed ? 'Yes' : 'No'}</p>
                <p><strong>Content Type:</strong> ${data.content_type ? data.content_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown'}</p>
            </div>
        </div>
        <hr>
        <h6>Extracted Text:</h6>
        <div class="bg-white p-3 rounded border">
            <pre class="mb-0" style="white-space: pre-wrap;">${data.text || 'No text extracted'}</pre>
        </div>
    `;
    
    // Show study suggestions
    if (data.suggestions) {
        suggestionsDiv.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <h6><i class="fas fa-clipboard-list me-2"></i>Summary</h6>
                    <p class="mb-2">${data.suggestions.summary || 'No summary available'}</p>
                </div>
                <div class="col-md-4">
                    <h6><i class="fas fa-lightbulb me-2"></i>Explanation</h6>
                    <p class="mb-2">${data.suggestions.explanation || 'No explanation available'}</p>
                </div>
                <div class="col-md-4">
                    <h6><i class="fas fa-question-circle me-2"></i>Quiz Questions</h6>
                    <ul class="list-unstyled mb-0">
                        ${data.suggestions.quiz_questions ? data.suggestions.quiz_questions.map(q => `<li>• ${q}</li>`).join('') : '<li>No questions available</li>'}
                    </ul>
                </div>
            </div>
        `;
    } else {
        suggestionsDiv.innerHTML = `
            <div class="text-center">
                <p class="mb-0">No study suggestions available for this content type.</p>
            </div>
        `;
    }
    
    resultsDiv.classList.remove('d-none');
}

function showError(message) {
    const resultsDiv = document.getElementById('ocrResults');
    const contentDiv = document.getElementById('resultsContent');
    const classificationDiv = document.getElementById('contentClassification');
    const suggestionsDiv = document.getElementById('studySuggestions');
    
    classificationDiv.innerHTML = '';
    suggestionsDiv.classList.add('d-none');
    
    contentDiv.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error:</strong> ${message}
        </div>
    `;
    
    resultsDiv.classList.remove('d-none');
}

function showOCRModal() {
    const modal = new bootstrap.Modal(document.getElementById('ocrModal'));
    modal.show();
}
</script>



